#!/bin/bash

root="$(git rev-parse --show-toplevel)"
[ -d "$root" ] || exit 1

owndir="$(cd "$(dirname "$0")"; pwd -P)"

OS_NAME=$(uname)

if [ "$OS_NAME" = "Darwin" ]; then
  FIND_ARGS="-perm +0111"
else
  FIND_ARGS="-executable"
fi

echo "Processing formatter script ..."
git diff --name-only --cached --diff-filter=ACM | awk -v prefix="$root/" '{print prefix $0}' > tmp-filelist.txt
"$owndir/formatter" < tmp-filelist.txt || abort=1
cat tmp-filelist.txt | xargs git add 
rm tmp-filelist.txt

echo "Processing linter script ..."
[ -d "$root/build/linter" ] && rm -rf "$root/build/linter"
"$owndir/linter" "$root" "$root/build/linter" || exit 1
echo "Lint result can be found in PROJECT/build/linter"